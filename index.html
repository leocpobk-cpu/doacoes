<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Sistema de controle de doa√ß√µes de viveres para a comunidade">
    <meta name="theme-color" content="#667eea">
    <title>Sistema de Doa√ß√µes</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2196f3;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: clamp(1.3em, 4vw, 1.8em);
            margin-bottom: 5px;
        }

        .header p {
            font-size: clamp(0.85em, 2.5vw, 0.95em);
            opacity: 0.95;
        }

        .content {
            padding: 15px;
        }

        .resumo {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: clamp(0.85em, 2.5vw, 0.95em);
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .lista-doacoes {
            list-style: none;
        }

        .item-lista {
            padding: 12px 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: clamp(0.9em, 2.5vw, 1em);
            line-height: 1.7;
            position: relative;
        }

        .item-lista:hover {
            background: #f9f9f9;
        }

        .item-numero {
            color: #999;
            font-weight: bold;
            display: inline-block;
            min-width: 25px;
        }

        .item-nome {
            font-weight: 600;
            color: #333;
        }

        .item-doacoes {
            color: #2196f3;
            font-weight: 500;
            margin-left: 5px;
        }

        .item-faltam {
            color: #ff5722;
            font-style: italic;
            margin-left: 5px;
        }

        .item-completo {
            background: #e8f5e9 !important;
        }

        .item-completo::after {
            content: '‚úÖ';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn-doar-linha {
            background: #2196f3;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            font-family: inherit;
        }

        .btn-doar-linha:hover {
            background: #1976d2;
        }

        .btn-remover {
            background: #f44336;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .btn-remover:hover {
            background: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: clamp(1.2em, 3vw, 1.5em);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: clamp(0.9em, 2.5vw, 1em);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: clamp(0.9em, 2.5vw, 1em);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2196f3;
        }

        .form-group small {
            display: block;
            color: #999;
            margin-top: 3px;
            font-size: clamp(0.8em, 2vw, 0.85em);
        }

        .form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.9em, 2.5vw, 1em);
            font-weight: 600;
            font-family: inherit;
        }

        .btn-primary:hover {
            background: #1976d2;
        }

        .btn-secondary {
            background: #ccc;
            color: #333;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(0.9em, 2.5vw, 1em);
            font-family: inherit;
        }

        .btn-secondary:hover {
            background: #999;
        }

        .info-pix {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }

        .info-pix strong {
            color: #1976d2;
            display: block;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .info-pix p {
            margin: 0;
            color: #333;
            line-height: 1.6;
        }

        @media (max-width: 600px) {
            .content {
                padding: 10px;
            }

            .form-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Controle de Doa√ß√µes</h1>
            <p>Lista de viveres necess√°rios</p>
        </div>

        <div class="content">
            <div class="resumo">
                <strong>Resumo:</strong> <span id="resumo-texto">Carregando...</span>
            </div>

            <ul class="lista-doacoes" id="lista-itens">
                <li class="loading">‚è≥ Carregando dados...</li>
            </ul>
        </div>
    </div>

    <!-- Modal de Doa√ß√£o -->
    <div id="modal-doacao" class="modal">
        <div class="modal-content">
            <h2>Registrar Doa√ß√£o</h2>
            <form id="form-doacao">
                <input type="hidden" id="item-id">
                
                <div class="form-group">
                    <label>Item:</label>
                    <div id="item-nome-modal" style="padding: 10px; background: #f5f5f5; border-radius: 5px; font-weight: 600; font-size: 1.05em;"></div>
                </div>

                <div class="form-group">
                    <label for="doador-nome">Seu Nome: *</label>
                    <input type="text" id="doador-nome" required placeholder="Digite seu nome">
                </div>

                <div class="form-group">
                    <label for="doador-regiao">Regi√£o (Opcional):</label>
                    <input type="text" id="doador-regiao" placeholder="Ex: R04, R13, Figueiral">
                </div>

                <div class="form-group">
                    <label for="tipo-doacao">Tipo de Doa√ß√£o: *</label>
                    <select id="tipo-doacao" required>
                        <option value="item">Doar o Item</option>
                        <option value="dinheiro">Doar em Dinheiro</option>
                    </select>
                </div>

                <div class="info-pix" id="info-pix">
                    <strong>üì± Dados para PIX:</strong>
                    <p><strong>Chave:</strong> 65 99289-8916</p>
                    <p><strong>Favorecido:</strong> Willem Santos - NUBANK</p>
                </div>

                <div class="form-group" id="grupo-quantidade">
                    <label for="quantidade">Quantidade: *</label>
                    <input type="number" id="quantidade" step="0.01" min="0.01" required>
                    <small id="quantidade-disponivel"></small>
                </div>

                <div class="form-group" id="grupo-valor" style="display: none;">
                    <label for="valor-dinheiro">Valor (R$): *</label>
                    <input type="number" id="valor-dinheiro" step="0.01" min="0.01" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="observacao">Observa√ß√£o (Opcional):</label>
                    <input type="text" id="observacao" placeholder="Alguma observa√ß√£o adicional">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Registrar</button>
                    <button type="button" class="btn-secondary" onclick="fecharModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO SUPABASE
        // ============================================
        
        const SUPABASE_URL = 'https://fwmlimudntlrkeukvyjg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3bWxpbXVkbnRscmtldWt2eWpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2OTkyNTMsImV4cCI6MjA4MDI3NTI1M30.Okcp4xYzu5FHlcn1baGFiy5dCvX2-mg1PVr9IiBh7Ko';
        
        // Cliente Supabase
        const { createClient } = window.supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // SENHA DE ADMINISTRADOR
        const SENHA_ADMIN = '0016275784390';

        // ============================================
        // FUN√á√ïES DE BANCO DE DADOS
        // ============================================

        // Carrega todos os itens
        async function carregarItens() {
            try {
                // Busca itens
                const { data: itens, error: erroItens } = await supabaseClient
                    .from('itens_doacao')
                    .select('*')
                    .order('id');

                if (erroItens) throw erroItens;

                // Busca doa√ß√µes
                const { data: doacoes, error: erroDoacoes } = await supabaseClient
                    .from('doacoes')
                    .select('*')
                    .order('criado_em', { ascending: false });

                if (erroDoacoes) throw erroDoacoes;

                // Calcula quantidades doadas e prepara dados
                const itensComDoacoes = itens.map(item => {
                    const doacoesItem = doacoes.filter(d => d.item_id === item.id);
                    const quantidade_doada = doacoesItem.reduce((sum, d) => sum + parseFloat(d.quantidade || 0), 0);
                    
                    return {
                        ...item,
                        quantidade_doada,
                        doacoes: doacoesItem
                    };
                });

                renderizarItens(itensComDoacoes);
                atualizarResumo(itensComDoacoes, doacoes);
            } catch (erro) {
                console.error('Erro ao carregar dados:', erro);
                document.getElementById('lista-itens').innerHTML = 
                    '<li style="text-align:center;color:#f44336;">‚ùå Erro ao carregar dados. Verifique sua conex√£o.</li>';
            }
        }

        // Renderiza itens na lista
        function renderizarItens(itens) {
            const container = document.getElementById('lista-itens');
            
            if (itens.length === 0) {
                container.innerHTML = '<li style="text-align:center;color:#999;">Nenhum item encontrado</li>';
                return;
            }

            container.innerHTML = itens.map((item, index) => {
                const restante = parseFloat(item.quantidade_total) - item.quantidade_doada;
                const completo = restante <= 0;
                
                // Monta texto das doa√ß√µes
                let textoDoacoes = '';
                if (item.doacoes.length > 0) {
                    textoDoacoes = item.doacoes.map(d => {
                        let texto = `${d.doador_nome}${d.doador_regiao ? ' ' + d.doador_regiao : ''}`;
                        if (d.tipo_doacao === 'dinheiro') {
                            texto += ` R$ ${parseFloat(d.valor_dinheiro || 0).toFixed(2)}`;
                        } else {
                            texto += ` ${parseFloat(d.quantidade || 0)} ${item.unidade}`;
                        }
                        return `${texto} <button class="btn-remover" onclick="removerDoacao(${d.id})" title="Remover (somente admin)">üóëÔ∏è</button>`;
                    }).join(', ');
                }
                
                // Monta texto de faltam
                let textoFaltam = '';
                if (!completo && item.doacoes.length > 0) {
                    textoFaltam = `<span class="item-faltam">(Faltam ${restante.toFixed(2)} ${item.unidade})</span>`;
                }

                return `
                    <li class="item-lista ${completo ? 'item-completo' : ''}">
                        <span class="item-numero">${index + 1}.</span>
                        <span class="item-nome">${item.descricao} ${parseFloat(item.quantidade_total)} ${item.unidade}</span>
                        ${textoDoacoes ? ` - <span class="item-doacoes">${textoDoacoes}</span>` : ''}
                        ${textoFaltam}
                        ${!completo ? `<button class="btn-doar-linha" onclick="abrirModalDoacao(${item.id})">Doar</button>` : ''}
                    </li>
                `;
            }).join('');
        }

        // Atualiza resumo
        function atualizarResumo(itens, doacoes) {
            const completos = itens.filter(i => i.quantidade_doada >= parseFloat(i.quantidade_total)).length;
            const pendentes = itens.filter(i => i.quantidade_doada === 0).length;
            const doadores = new Set(doacoes.map(d => d.doador_nome)).size;
            const totalDinheiro = doacoes
                .filter(d => d.tipo_doacao === 'dinheiro')
                .reduce((sum, d) => sum + parseFloat(d.valor_dinheiro || 0), 0);

            const texto = `${completos} itens completos, ${pendentes} pendentes ‚Ä¢ ${doadores} doadores ‚Ä¢ R$ ${totalDinheiro.toFixed(2)} em dinheiro`;
            document.getElementById('resumo-texto').textContent = texto;
        }

        // Abre modal de doa√ß√£o
        async function abrirModalDoacao(itemId) {
            try {
                // Busca item
                const { data: item, error } = await supabaseClient
                    .from('itens_doacao')
                    .select('*')
                    .eq('id', itemId)
                    .single();

                if (error) throw error;

                // Busca doa√ß√µes do item
                const { data: doacoes } = await supabaseClient
                    .from('doacoes')
                    .select('quantidade')
                    .eq('item_id', itemId);

                const quantidade_doada = doacoes.reduce((sum, d) => sum + parseFloat(d.quantidade || 0), 0);
                const restante = parseFloat(item.quantidade_total) - quantidade_doada;
                
                document.getElementById('item-id').value = itemId;
                document.getElementById('item-nome-modal').textContent = item.descricao;
                document.getElementById('quantidade').max = restante;
                document.getElementById('quantidade').value = restante > 1 ? 1 : restante.toFixed(2);
                document.getElementById('quantidade-disponivel').textContent = `Restam: ${restante.toFixed(2)} ${item.unidade}`;
                document.getElementById('modal-doacao').classList.add('active');
                
                // Foca no campo nome
                setTimeout(() => document.getElementById('doador-nome').focus(), 300);
            } catch (erro) {
                console.error('Erro ao abrir modal:', erro);
                alert('‚ùå Erro ao carregar item. Tente novamente.');
            }
        }

        // Fecha modal
        function fecharModal() {
            document.getElementById('modal-doacao').classList.remove('active');
            document.getElementById('form-doacao').reset();
            document.getElementById('grupo-valor').style.display = 'none';
            document.getElementById('info-pix').style.display = 'none';
            document.getElementById('grupo-quantidade').style.display = 'block';
        }

        // Alterna tipo de doa√ß√£o
        document.getElementById('tipo-doacao').addEventListener('change', (e) => {
            const isDinheiro = e.target.value === 'dinheiro';
            document.getElementById('grupo-valor').style.display = isDinheiro ? 'block' : 'none';
            document.getElementById('info-pix').style.display = isDinheiro ? 'block' : 'none';
            document.getElementById('grupo-quantidade').style.display = isDinheiro ? 'none' : 'block';
            document.getElementById('valor-dinheiro').required = isDinheiro;
            document.getElementById('quantidade').required = !isDinheiro;
        });

        // Envia doa√ß√£o
        document.getElementById('form-doacao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const itemId = parseInt(document.getElementById('item-id').value);
            const tipoDoacao = document.getElementById('tipo-doacao').value;

            try {
                const novaDoacao = {
                    item_id: itemId,
                    doador_nome: document.getElementById('doador-nome').value.trim(),
                    doador_regiao: document.getElementById('doador-regiao').value.trim() || null,
                    tipo_doacao: tipoDoacao,
                    quantidade: tipoDoacao === 'item' ? parseFloat(document.getElementById('quantidade').value) : null,
                    valor_dinheiro: tipoDoacao === 'dinheiro' ? parseFloat(document.getElementById('valor-dinheiro').value) : null,
                    observacao: document.getElementById('observacao').value.trim() || null
                };

                const { error } = await supabaseClient
                    .from('doacoes')
                    .insert([novaDoacao]);

                if (error) throw error;

                alert('‚úÖ Doa√ß√£o registrada com sucesso!');
                fecharModal();
                carregarItens();
            } catch (erro) {
                console.error('Erro ao salvar doa√ß√£o:', erro);
                alert('‚ùå Erro ao registrar doa√ß√£o. Tente novamente.');
            }
        });

        // Remove doa√ß√£o (APENAS ADMIN)
        async function removerDoacao(doacaoId) {
            const senha = prompt('üîê Esta a√ß√£o requer senha de administrador:');
            if (!senha) return;
            
            if (senha !== SENHA_ADMIN) {
                alert('‚ùå Senha incorreta! Apenas administradores podem remover doa√ß√µes.');
                return;
            }
            
            if (!confirm('Tem certeza que deseja remover esta doa√ß√£o?')) return;

            try {
                const { error } = await supabaseClient
                    .from('doacoes')
                    .delete()
                    .eq('id', doacaoId);

                if (error) throw error;

                alert('‚úÖ Doa√ß√£o removida com sucesso!');
                carregarItens();
            } catch (erro) {
                console.error('Erro ao remover doa√ß√£o:', erro);
                alert('‚ùå Erro ao remover doa√ß√£o. Tente novamente.');
            }
        }

        // Fecha modal ao clicar fora
        document.getElementById('modal-doacao').addEventListener('click', (e) => {
            if (e.target.id === 'modal-doacao') {
                fecharModal();
            }
        });

        // Inicializa ao carregar p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ Sistema iniciado - conectado ao Supabase');
            carregarItens();
        });
    </script>
</body>
</html>
